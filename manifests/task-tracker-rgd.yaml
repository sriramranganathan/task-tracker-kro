apiVersion: kro.run/v1alpha1
kind: ResourceGraphDefinition
metadata:
  name: task-tracker-app
  annotations:
    # Sync wave 1 ensures the RGD (CRD) is created before the instance
    argocd.argoproj.io/sync-wave: "1"
spec:
  schema:
    apiVersion: v1alpha1
    kind: TaskTrackerApp
    spec:
      namespace:
        type: string
        description: "Target namespace for all resources"
      appName:
        type: string
        description: "Application name prefix used for resource naming"
      appTitle:
        type: string
        description: "Display title shown in the application UI"
        default: "Task Tracker"
      themeColor:
        type: string
        description: "UI theme color in hex format"
        default: "#0066cc"
      awsRegion:
        type: string
        description: "AWS region where resources will be created"
      awsAccountId:
        type: string
        description: "AWS account ID"
      oidcProviderArn:
        type: string
        description: "OIDC provider ARN for IRSA authentication"
      ecrImageUri:
        type: string
        description: "ECR repository URI for the container image"
      imageTag:
        type: string
        description: "Container image tag"
        default: "latest"
      replicas:
        type: integer
        description: "Number of pod replicas"
        default: 2

  resources:
    - id: iamPolicy
      template:
        apiVersion: iam.services.k8s.aws/v1alpha1
        kind: Policy
        metadata:
          name: ${schema.spec.appName}-dynamodb-policy
          namespace: ${schema.spec.namespace}
        spec:
          name: ${schema.spec.appName}-dynamodb-policy
          description: "IAM policy for Task Tracker application to access DynamoDB"
          policyDocument: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:PutItem",
                    "dynamodb:GetItem",
                    "dynamodb:Query",
                    "dynamodb:Scan",
                    "dynamodb:UpdateItem",
                    "dynamodb:DeleteItem"
                  ],
                  "Resource": "arn:aws:dynamodb:${schema.spec.awsRegion}:${schema.spec.awsAccountId}:table/${schema.spec.appName}-tasks"
                }
              ]
            }

    - id: iamRole
      template:
        apiVersion: iam.services.k8s.aws/v1alpha1
        kind: Role
        metadata:
          name: ${schema.spec.appName}-role
          namespace: ${schema.spec.namespace}
        spec:
          name: ${schema.spec.appName}-role
          description: "IAM role for Task Tracker application with IRSA"
          assumeRolePolicyDocument: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "${schema.spec.oidcProviderArn}"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                      "${schema.spec.oidcProviderArn | split('/') | last}:sub": "system:serviceaccount:${schema.spec.namespace}:${schema.spec.appName}-sa",
                      "${schema.spec.oidcProviderArn | split('/') | last}:aud": "sts.amazonaws.com"
                    }
                  }
                }
              ]
            }

    - id: policyAttachment
      template:
        apiVersion: iam.services.k8s.aws/v1alpha1
        kind: RolePolicyAttachment
        metadata:
          name: ${schema.spec.appName}-policy-attachment
          namespace: ${schema.spec.namespace}
        spec:
          policyARN: ${iamPolicy.status.ackResourceMetadata.arn}
          roleName: ${iamRole.spec.name}

    - id: dynamodbTable
      template:
        apiVersion: dynamodb.services.k8s.aws/v1alpha1
        kind: Table
        metadata:
          name: ${schema.spec.appName}-table
          namespace: ${schema.spec.namespace}
        spec:
          tableName: ${schema.spec.appName}-tasks
          attributeDefinitions:
            - attributeName: taskId
              attributeType: S
            - attributeName: createdAt
              attributeType: N
          keySchema:
            - attributeName: taskId
              keyType: HASH
            - attributeName: createdAt
              keyType: RANGE
          billingMode: PAY_PER_REQUEST
          tags:
            - key: Application
              value: ${schema.spec.appName}
            - key: ManagedBy
              value: KRO

    - id: serviceAccount
      template:
        apiVersion: v1
        kind: ServiceAccount
        metadata:
          name: ${schema.spec.appName}-sa
          namespace: ${schema.spec.namespace}
          annotations:
            eks.amazonaws.com/role-arn: ${iamRole.status.ackResourceMetadata.arn}

    - id: configmap
      template:
        apiVersion: v1
        kind: ConfigMap
        metadata:
          name: ${schema.spec.appName}-config
          namespace: ${schema.spec.namespace}
        data:
          DYNAMODB_TABLE_NAME: ${schema.spec.appName}-tasks
          AWS_REGION: ${schema.spec.awsRegion}
          APP_TITLE: ${schema.spec.appTitle}
          APP_THEME_COLOR: ${schema.spec.themeColor}

    - id: deployment
      template:
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: ${schema.spec.appName}
          namespace: ${schema.spec.namespace}
          annotations:
            reloader.stakater.com/auto: "true"
        spec:
          replicas: ${schema.spec.replicas}
          selector:
            matchLabels:
              app: ${schema.spec.appName}
          template:
            metadata:
              labels:
                app: ${schema.spec.appName}
            spec:
              serviceAccountName: ${schema.spec.appName}-sa
              containers:
                - name: ${schema.spec.appName}
                  image: ${schema.spec.ecrImageUri}:${schema.spec.imageTag}
                  ports:
                    - containerPort: 8080
                      name: http
                  envFrom:
                    - configMapRef:
                        name: ${schema.spec.appName}-config
                  resources:
                    requests:
                      cpu: 100m
                      memory: 128Mi
                    limits:
                      cpu: 500m
                      memory: 512Mi
                  livenessProbe:
                    httpGet:
                      path: /health
                      port: 8080
                    initialDelaySeconds: 30
                    periodSeconds: 10
                    timeoutSeconds: 5
                    failureThreshold: 3
                  readinessProbe:
                    httpGet:
                      path: /ready
                      port: 8080
                    initialDelaySeconds: 10
                    periodSeconds: 5
                    timeoutSeconds: 3
                    failureThreshold: 3

    - id: service
      template:
        apiVersion: v1
        kind: Service
        metadata:
          name: ${schema.spec.appName}
          namespace: ${schema.spec.namespace}
          labels:
            app: ${schema.spec.appName}
        spec:
          type: LoadBalancer
          selector:
            app: ${schema.spec.appName}
          ports:
            - protocol: TCP
              port: 80
              targetPort: 8080
              name: http
